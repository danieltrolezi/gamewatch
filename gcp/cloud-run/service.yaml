apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: <GCP_CLOUD_RUN_SERVICE>
  namespace: '<GCP_PROJECT_NUMBER>'
  labels:
    cloud.googleapis.com/location: <GCP_REGION>
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/ingress-status: all
    run.googleapis.com/minScale: '1'
spec:
  template:
    metadata:
      labels:
        run.googleapis.com/startupProbeType: Default
      annotations:
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "2"
        run.googleapis.com/cpu-throttling: 'false'
        run.googleapis.com/startup-cpu-boost: 'true'
    spec:
      containerConcurrency: 80
      timeoutSeconds: 300
      serviceAccountName: <GCP_SERVICE_ACCOUNT>
      containers:
      - name: app
        image: <DOCKER_IMAGE>
        ports:
          - name: http1
            containerPort: 80
        resources:
          limits:
            cpu: 1000m
            memory: 512Mi
        startupProbe:
          timeoutSeconds: 240
          periodSeconds: 240
          failureThreshold: 1
          tcpSocket:
            port: 80
        livenessProbe:
          httpGet:
            path: /api/up
            port: 80
          initialDelaySeconds: 20
          timeoutSeconds: 5
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/up
            port: 80
          initialDelaySeconds: 20
          timeoutSeconds: 5
          periodSeconds: 10
        env:
          - name: RUN_MODE
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_RUN_MODE
                key: latest
          - name: APP_NAME
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_NAME
                key: latest
          - name: APP_VERSION
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_VERSION
                key: latest
          - name: APP_URL
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_URL
                key: latest
          - name: APP_ENV
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_ENV
                key: latest
          - name: APP_KEY
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_KEY
                key: latest
          - name: APP_DEBUG
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_APP_DEBUG
                key: latest
          - name: DB_CONNECTION
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_CONNECTION
                key: latest
          - name: DB_HOST
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_HOST
                key: latest
          - name: DB_PORT
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_PORT
                key: latest
          - name: DB_DATABASE
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_DATABASE
                key: latest
          - name: DB_USERNAME
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_USERNAME
                key: latest
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DB_PASSWORD
                key: latest
          - name: REDIS_CONNECTION
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_REDIS_CONNECTION
                key: latest
          - name: REDIS_HOST
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_REDIS_HOST
                key: latest
          - name: REDIS_PORT
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_REDIS_PORT
                key: latest
          - name: REDIS_USERNAME
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_REDIS_USERNAME
                key: latest
          - name: REDIS_PASSWORD
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_REDIS_PASSWORD
                key: latest
          - name: RAWG_API_KEY
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_RAWG_API_KEY
                key: latest
          - name: RAWG_API_HOST
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_RAWG_API_HOST
                key: latest
          - name: JWT_EXPIRES
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_JWT_EXPIRES
                key: latest
          - name: DISCORD_APP_ID
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DISCORD_APP_ID
                key: latest
          - name: DISCORD_PUBLIC_KEY
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DISCORD_PUBLIC_KEY
                key: latest
          - name: DISCORD_BOT_TOKEN
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DISCORD_BOT_TOKEN
                key: latest
          - name: DISCORD_API_HOST
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_DISCORD_API_HOST
                key: latest
          - name: ROOT_DISCORD_USER_ID
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_ROOT_DISCORD_USER_ID
                key: latest
          - name: ROOT_DISCORD_USERNAME
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_ROOT_DISCORD_USERNAME
                key: latest
          - name: ROOT_DISCORD_CHANNEL_ID
            valueFrom:
              secretKeyRef:
                name: GAMEWATCH_ROOT_DISCORD_CHANNEL_ID
                key: latest